name: Terraform Plan (azure dev)

on:
  pull_request:
    branches:
      - main
      - dev
    paths:
      - '**.tf'
      - 'modules/**'
      - 'live/azure/dev/**'
      - 'ci/github_actions/**'

env:
  TF_WORKING_DIR: live/azure/dev

jobs:
  plan-azure-dev:
    name: Terraform plan (azure dev)
    runs-on: ubuntu-latest

    permissions:
      contents: read          # checkout repo
      pull-requests: write    # post PR comments with plan
      id-token: write         # needed for Azure OIDC if you use it later

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.7

      # Authenticate to Azure using a service principal stored in AZURE_CREDENTIALS
      # Secret format:
      # {
      #   "clientId": "<APP_ID>",
      #   "clientSecret": "<PASSWORD>",
      #   "subscriptionId": "<SUBSCRIPTION_ID>",
      #   "tenantId": "<TENANT_ID>"
      # }
      - name: Azure login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Install tflint
        run: |
          curl -s https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash

      - name: Install tfsec
        run: |
          curl -sSfL https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | sh -s -- -b /usr/local/bin

      - name: Install Conftest
        run: |
          curl -L https://github.com/open-policy-agent/conftest/releases/latest/download/conftest_Linux_x86_64.tar.gz -o conftest.tar.gz
          tar xzf conftest.tar.gz
          sudo mv conftest /usr/local/bin/

      - name: Terraform fmt (check only)
        run: terraform -chdir=${{ env.TF_WORKING_DIR }} fmt -check -recursive

      - name: Terraform init
        run: terraform -chdir=${{ env.TF_WORKING_DIR }} init -input=false

      - name: Terraform validate
        run: terraform -chdir=${{ env.TF_WORKING_DIR }} validate

      - name: Run tflint
        run: tflint --chdir ${{ env.TF_WORKING_DIR }}

      - name: Run tfsec
        run: tfsec ${{ env.TF_WORKING_DIR }}

      - name: Terraform plan
        run: |
          terraform -chdir=${{ env.TF_WORKING_DIR }} plan -var-file=dev.tfvars -out=plan.tfplan
          terraform -chdir=${{ env.TF_WORKING_DIR }} show -json plan.tfplan > ${{ env.TF_WORKING_DIR }}/plan.json

      - name: Run Conftest (policy-as-code)
        run: conftest test ${{ env.TF_WORKING_DIR }}/plan.json -p modules/security/policies/conftest

      - name: Save human-readable plan
        run: terraform -chdir=${{ env.TF_WORKING_DIR }} show -no-color plan.tfplan > plan.txt

      - name: Upload plan artifacts
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan-azure-dev
          path: |
            ${{ env.TF_WORKING_DIR }}/plan.tfplan
            ${{ env.TF_WORKING_DIR }}/plan.txt

      - name: Comment plan on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const planPath = path.join(process.env.TF_WORKING_DIR, 'plan.txt');
            const plan = fs.readFileSync(planPath, 'utf8');

            const truncatedPlan = plan.length > 60000 ? plan.slice(0, 60000) + '\n\n...[truncated]...' : plan;

            const body = [
              'Terraform plan for **azure dev** environment:',
              '',
              '```hcl',
              truncatedPlan,
              '```'
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });


